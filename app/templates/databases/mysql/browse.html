{% extends "base.html" %}

{% block title %}Browse Table: {{ table_name }} - MySQL Dashboard{% endblock %}

{% block content %}
{% include "components/sidebar.html" %}

<main class="flex-1 flex flex-col min-w-0 bg-slate-50 dark:bg-dark-bg transition-colors duration-200">
    <header
        class="h-16 bg-white dark:bg-dark-surface border-b border-slate-200 dark:border-dark-border flex items-center justify-between px-8 transition-colors">
        <div class="flex items-center gap-4">
            <a href="/databases/{{ database.id }}/mysql" class="text-slate-400 hover:text-slate-600">
                <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
                </svg>
            </a>
            <h2 class="text-2xl font-bold text-slate-800 dark:text-slate-200">
                Browse: <span class="text-slate-500 font-semibold">{{ database.database_name }}</span>
                <span class="text-slate-300 mx-1">/</span>
                <span class="text-primary">{{ table_name }}</span>
            </h2>
        </div>
        </div>
        <div class="flex items-center gap-3">
            <div
                class="flex items-center bg-white dark:bg-dark-surface border border-slate-300 dark:border-dark-border rounded-lg p-0.5">
                <button onclick="openImportModal()"
                    class="px-3 py-1.5 text-xs font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-dark-hover rounded-md transition-colors flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path>
                    </svg>
                    Import
                </button>
                <div class="w-px h-4 bg-slate-300 dark:bg-dark-border mx-0.5"></div>
                <button onclick="openExportModal()"
                    class="px-3 py-1.5 text-xs font-medium text-slate-700 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-dark-hover rounded-md transition-colors flex items-center gap-1">
                    <svg class="w-3.5 h-3.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path>
                    </svg>
                    Export
                </button>
            </div>


        </div>
    </header>

    <div class="flex-1 overflow-y-auto p-8">
        <div
            class="bg-white dark:bg-dark-surface rounded-xl shadow-sm border border-slate-200 dark:border-dark-border overflow-hidden transition-colors">
            <div class="p-4 border-b border-slate-200 dark:border-dark-border">
                <div class="flex flex-col gap-4">
                    <!-- Top Row: Actions and Total -->
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span
                                class="text-sm font-medium text-slate-500 dark:text-slate-400 bg-slate-100 dark:bg-slate-800 px-3 py-1 rounded-full">{{
                                total_rows }} rows</span>
                            <div class="h-4 w-px bg-slate-300 dark:bg-dark-border"></div>
                            <button
                                onclick="window.location.href='/databases/{{ database.id }}/mysql/tables/{{ table_name }}/insert'"
                                class="px-3 py-1.5 bg-primary text-white text-sm font-medium rounded-lg hover:bg-blue-600 transition-colors flex items-center gap-2 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M12 4v16m8-8H4"></path>
                                </svg>
                                Insert Row
                            </button>
                            <button id="bulk-delete-btn" onclick="bulkDeleteRows()"
                                class="hidden px-3 py-1.5 bg-red-500 text-white text-sm font-medium rounded-lg hover:bg-red-600 transition-colors flex items-center gap-2 shadow-sm">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                    </path>
                                </svg>
                                Delete (<span id="selected-count">0</span>)
                            </button>
                        </div>

                        <!-- Rows per page (moved here for cleaner bottom bar) -->
                        <div class="flex items-center gap-2">
                            <span class="text-xs text-slate-500 dark:text-slate-400">Rows:</span>
                            <select onchange="window.location.href=this.value"
                                class="py-1 pl-2 pr-6 border-slate-300 dark:border-dark-border bg-white dark:bg-dark-bg text-slate-900 dark:text-slate-200 rounded-lg text-xs focus:ring-primary focus:border-primary transition-colors cursor-pointer">
                                {% for limit in [10, 25, 50, 100] %}
                                <option
                                    value="?limit={{ limit }}{% if search %}&search={{ search }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}{% endif %}"
                                    {% if per_page==limit %}selected{% endif %}>{{ limit }}</option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Bottom Row: Search and Pagination -->
                    <div class="flex items-center justify-between gap-4">
                        <form method="GET" class="flex flex-1 gap-2 max-w-2xl">
                            <div class="relative flex-1">
                                <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                    <svg class="h-4 w-4 text-slate-400" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
                                    </svg>
                                </div>
                                <input type="text" name="search" value="{{ search or '' }}"
                                    class="block w-full pl-9 pr-3 py-1.5 border border-slate-300 dark:border-dark-border rounded-lg leading-5 bg-white dark:bg-dark-bg text-slate-900 dark:text-slate-200 placeholder-slate-500 dark:placeholder-slate-400 focus:outline-none focus:placeholder-slate-400 focus:border-primary focus:ring-1 focus:ring-primary text-sm transition-colors shadow-sm"
                                    placeholder="Search columns...">
                                {% if sort_by %}
                                <input type="hidden" name="sort_by" value="{{ sort_by }}">
                                <input type="hidden" name="sort_order" value="{{ sort_order }}">
                                {% endif %}
                                {% if per_page != 25 %}
                                <input type="hidden" name="limit" value="{{ per_page }}">
                                {% endif %}
                            </div>
                            <button type="submit"
                                class="px-3 py-1.5 bg-slate-100 dark:bg-slate-800 text-slate-700 dark:text-slate-300 text-sm font-medium rounded-lg hover:bg-slate-200 dark:hover:bg-slate-700 transition-colors shadow-sm">
                                Search
                            </button>
                        </form>

                        <!-- Pagination -->
                        <div
                            class="flex items-center border border-slate-300 dark:border-dark-border rounded-lg overflow-hidden transition-colors shadow-sm">
                            <a href="?page={{ current_page - 1 }}&limit={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}{% endif %}"
                                class="px-2 py-1.5 bg-white dark:bg-dark-surface text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-dark-hover border-r border-slate-300 dark:border-dark-border transition-colors {% if current_page <= 1 %}pointer-events-none opacity-50{% endif %}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M15 19l-7-7 7-7"></path>
                                </svg>
                            </a>
                            <span
                                class="px-3 py-1.5 bg-slate-50 dark:bg-dark-bg text-xs font-medium text-slate-600 dark:text-slate-300 transition-colors min-w-[3rem] text-center">
                                {{ current_page }} / {{ total_pages }}
                            </span>
                            <a href="?page={{ current_page + 1 }}&limit={{ per_page }}{% if search %}&search={{ search }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}&sort_order={{ sort_order }}{% endif %}"
                                class="px-2 py-1.5 bg-white dark:bg-dark-surface text-slate-600 dark:text-slate-300 hover:bg-slate-50 dark:hover:bg-dark-hover border-l border-slate-300 dark:border-dark-border transition-colors {% if current_page >= total_pages %}pointer-events-none opacity-50{% endif %}">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M9 5l7 7-7 7">
                                    </path>
                                </svg>
                            </a>
                        </div>
                    </div>
                </div>
            </div>

            <div class="overflow-x-auto relative">
                {% if error %}
                <div class="p-6">
                    <div class="bg-red-50 border border-red-200 rounded-lg p-4">
                        <p class="text-sm text-red-800">Error: {{ error }}</p>
                    </div>
                </div>
                {% endif %}


                <table class="w-full text-left text-sm text-slate-600 dark:text-slate-400">
                    <thead
                        class="bg-slate-50/95 dark:bg-dark-hover/95 backdrop-blur sticky top-0 z-10 text-xs uppercase font-semibold text-slate-500 dark:text-slate-400 transition-colors shadow-sm">
                        <tr>
                            <th class="px-6 py-4 w-10">
                                <input type="checkbox" id="select-all-rows" onchange="toggleAllRows(this)"
                                    class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4 bg-transparent">
                            </th>
                            {% for column in columns %}
                            <th class="px-6 py-4 whitespace-nowrap">
                                <a href="?sort_by={{ column }}&sort_order={% if sort_by == column and sort_order == 'ASC' %}DESC{% else %}ASC{% endif %}{% if search %}&search={{ search }}{% endif %}&limit={{ per_page }}"
                                    class="group flex items-center gap-1 hover:text-slate-700">
                                    {{ column }}
                                    <span class="text-slate-400 group-hover:text-slate-600">
                                        {% if sort_by == column %}
                                        {% if sort_order == 'ASC' %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M5 15l7-7 7 7"></path>
                                        </svg>
                                        {% else %}
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                        {% endif %}
                                        {% else %}
                                        <svg class="w-4 h-4 opacity-0 group-hover:opacity-50" fill="none"
                                            stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M7 16V4m0 0L3 8m4-4l4 4m6 0v12m0 0l4-4m-4 4l-4-4"></path>
                                        </svg>
                                        {% endif %}
                                    </span>
                                </a>
                            </th>
                            {% endfor %}
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-slate-200 dark:divide-dark-border">
                        {% for row in rows %}
                        <tr
                            class="hover:bg-blue-50/50 dark:hover:bg-blue-900/10 even:bg-slate-50/50 dark:even:bg-white/5 transition-colors group border-b border-slate-100 dark:border-dark-border last:border-0">
                            <td class="px-6 py-4">
                                <input type="checkbox" class="row-checkbox" value="{{ row[primary_key] }}"
                                    onchange="updateBulkDeleteState()"
                                    class="rounded border-slate-300 text-primary focus:ring-primary h-4 w-4">
                            </td>
                            {% for column in columns %}
                            <td class="px-6 py-4 whitespace-nowrap">
                                <div class="max-w-xs truncate font-mono text-xs text-slate-700 dark:text-slate-300"
                                    title="{{ row[column] }}">
                                    {{ row[column] if row[column] is not none else 'NULL' }}
                                </div>
                            </td>
                            {% endfor %}
                            <td class="px-6 py-4 text-right whitespace-nowrap">
                                <div
                                    class="flex items-center justify-end gap-3 opacity-0 group-hover:opacity-100 transition-opacity">
                                    <a href="/databases/{{ database.id }}/mysql/tables/{{ table_name }}/rows/edit?pk_column={{ primary_key }}&pk_value={{ row[primary_key] }}"
                                        class="p-1 text-slate-400 hover:text-blue-600 hover:bg-blue-50 dark:hover:bg-blue-900/20 rounded transition-colors"
                                        title="Edit">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z">
                                            </path>
                                        </svg>
                                    </a>
                                    <button onclick="deleteRow('{{ primary_key }}', '{{ row[primary_key] }}')"
                                        class="p-1 text-slate-400 hover:text-red-500 hover:bg-red-50 dark:hover:bg-red-900/20 rounded transition-colors"
                                        title="Delete">
                                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16">
                                            </path>
                                        </svg>
                                    </button>
                                </div>
                            </td>
                        </tr>
                        {% endfor %}
                        {% if not rows %}
                        <tr>
                            <td colspan="{{ columns|length + 2 }}" class="px-6 py-12 text-center text-slate-500">
                                <div class="flex flex-col items-center justify-center gap-2">
                                    <svg class="w-8 h-8 text-slate-300" fill="none" stroke="currentColor"
                                        viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4">
                                        </path>
                                    </svg>
                                    <p>No data found</p>
                                </div>
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>

            <!-- Pagination -->
            <div
                class="px-6 py-4 border-t border-slate-200 dark:border-dark-border bg-slate-50 dark:bg-dark-surface/50 flex items-center justify-between transition-colors">
                <div class="text-sm text-slate-500 dark:text-slate-400">
                    Showing <span class="font-medium text-slate-700 dark:text-slate-200">{{ start_index }}</span> to
                    <span class="font-medium text-slate-700 dark:text-slate-200">{{ end_index }}</span> of <span
                        class="font-medium text-slate-700 dark:text-slate-200">{{ total_rows }}</span> entries
                </div>

            </div>
        </div>
    </div>
</main>

{% include "databases/mysql/partials/import_export_modal.html" %}

{% include "components/delete_modal.html" %}

<script>
    async function deleteRow(pkColumn, pkValue) {
        showDeleteModal(
            'Delete Row',
            'Are you sure you want to delete this row? This action cannot be undone.',
            async () => {
                try {
                    // Construct the correct URL: /databases/{db_id}/mysql/tables/{table_name}/rows
                    // We can use the current path but need to remove '/browse'
                    const currentPath = window.location.pathname;
                    const basePath = currentPath.endsWith('/browse') ? currentPath.slice(0, -7) : currentPath;

                    const response = await fetch(`${basePath}/rows?pk_column=${encodeURIComponent(pkColumn)}&pk_value=${encodeURIComponent(pkValue)}`, {
                        method: 'DELETE',
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        window.location.reload();
                    } else {
                        alert('Error deleting row: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error deleting row: ' + error.message);
                }
            }
        );
    }

    function toggleAllRows(source) {
        const checkboxes = document.querySelectorAll('.row-checkbox');
        checkboxes.forEach(cb => cb.checked = source.checked);
        updateBulkDeleteState();
    }

    function updateBulkDeleteState() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const btn = document.getElementById('bulk-delete-btn');
        const countSpan = document.getElementById('selected-count');

        if (checkboxes.length > 0) {
            btn.classList.remove('hidden');
            countSpan.textContent = checkboxes.length;
        } else {
            btn.classList.add('hidden');
        }

        // Update select all checkbox
        const allCheckboxes = document.querySelectorAll('.row-checkbox');
        const selectAll = document.getElementById('select-all-rows');
        selectAll.checked = checkboxes.length === allCheckboxes.length && allCheckboxes.length > 0;
    }

    async function bulkDeleteRows() {
        const checkboxes = document.querySelectorAll('.row-checkbox:checked');
        const pkValues = Array.from(checkboxes).map(cb => cb.value);

        if (pkValues.length === 0) return;

        showDeleteModal(
            'Batch Delete Rows',
            `Are you sure you want to delete ${pkValues.length} rows? This action cannot be undone.`,
            async () => {
                try {
                    const response = await fetch('/databases/{{ database.id }}/mysql/tables/{{ table_name }}/rows/batch-delete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            pk_column: '{{ primary_key }}',
                            pk_values: pkValues
                        })
                    });

                    const data = await response.json();

                    if (response.ok && data.success) {
                        window.location.reload();
                    } else {
                        alert('Error deleting rows: ' + (data.error || 'Unknown error'));
                    }
                } catch (error) {
                    alert('Error deleting rows: ' + error.message);
                }
            }
        );
    }
</script>
{% endblock %}